# ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ XCom Ð² Airflow

https://www.notion.so/korsak0v/Data-Engineer-185c62fdf79345eb9da9928356884ea0

## Ðž Ð²Ð¸Ð´ÐµÐ¾

ðŸ”¥ Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ð¾Ð½ÑÑ‚ÑŒ, ÐºÐ°Ðº Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ Ð² Apache Airflow, Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‚Ð°Ñ‚ÑŒÑÑ Ð² XComâ€™Ð°Ñ… Ð¸ Ð½Ðµ Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ
metastore Ð² ÑÐ²Ð°Ð»ÐºÑƒ?
Ð’ ÑÑ‚Ð¾Ð¼ [Ð²Ð¸Ð´ÐµÐ¾](https://youtu.be/DGUwzrJn_ag) Ñ€Ð°Ð·Ð±ÐµÑ€Ñ‘Ð¼ XCom Ð² Airflow Ñ Ð½ÑƒÐ»Ñ Ð½Ð° Ð¶Ð¸Ð²Ñ‹Ñ… Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°Ñ… DAGâ€™Ð¾Ð²: ÐºÐ°Ðº Ð¿ÑƒÑˆÐ¸Ñ‚ÑŒ Ð¸
Ð¿ÑƒÐ»Ð»Ð¸Ñ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð³Ð´Ð° XCom â€” ÑÑ‚Ð¾ ÑƒÐ´Ð¾Ð±Ð½Ð¾, Ð° ÐºÐ¾Ð³Ð´Ð° ÑÑ‚Ð¾ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº Ð±Ð¾Ð»Ð¸ Ð¸ Ð°Ð½Ñ‚Ð¸Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð°Ð¼.

Ð¡ÑÑ‹Ð»ÐºÐ¸:
ÐœÐµÐ½Ñ‚Ð¾Ñ€ÑÑ‚Ð²Ð¾/ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Data
Engineering â€” https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0
TG-ÐºÐ°Ð½Ð°Ð» â€” https://t.me/DataLikeQWERTY
Instagram â€” https://www.instagram.com/i__korsakov/
Habr â€” https://habr.com/ru/users/k0rsakov/publications/articles/

ðŸ” Ð§Ñ‚Ð¾ Ð² Ð²Ð¸Ð´ÐµÐ¾:

- ðŸ§  Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ XCom Ð² Apache Airflow Ð¸ Ð·Ð°Ñ‡ÐµÐ¼ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ DAG
- âš™ï¸ ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ DAG simple_push_xcom_values: ÐºÐ°Ðº ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ XCom Â«Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽÂ» Ð¸ Ð³Ð´Ðµ ÐµÐ³Ð¾ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð² Airflow UI
- ðŸ”Ž Ð“Ð´Ðµ Ð¶Ð¸Ð²ÑƒÑ‚ XComâ€™Ñ‹:
    - Ð²ÐºÐ»Ð°Ð´ÐºÐ° XCom Ð² Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ Airflow
    - Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° xcom Ð² Ð¼ÐµÑ‚Ð°ÑÑ‚Ð¾Ñ€Ðµ Ñ‡ÐµÑ€ÐµÐ· DBeaver
- ðŸ§ª DAG simple_dag:
    - Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ task_instance (ti) Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
    - Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð»ÑƒÑ‡ÑˆÐµ ÑÐ²Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ task_instance, Ð° Ð½Ðµ Ð¿Ð¾Ð»Ð°Ð³Ð°Ñ‚ÑŒÑÑ Ð½Ð° Â«Ð¼Ð°Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹Â» ti
    - ÐºÐ°Ðº TaskInstance ÑÐ²ÑÐ·Ð°Ð½ Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ DAGRun Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡
    - Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Debug Ð² IDE Ð½Ðµ Ð´Ð°Ñ‘Ñ‚ Ð¿Ð¾Ð»Ð½Ð¾Ñ†ÐµÐ½Ð½Ð¾Ð³Ð¾ TaskInstance Ð¸ ÐºÐ°Ðº Ð·Ð°Ð³Ð»ÑÐ½ÑƒÑ‚ÑŒ Ð² Â«ÐºÐ¸ÑˆÐºÐ¸Â» XComâ€™Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð´
- ðŸ”„ DAG simple_communications_between_tasks:
    - ÐºÐ°Ðº Ð¾Ð´Ð½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð° Ð¿ÑƒÑˆÐ¸Ñ‚ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· xcom_push, Ð° Ð´Ñ€ÑƒÐ³Ð°Ñ Ð·Ð°Ð±Ð¸Ñ€Ð°ÐµÑ‚ ÐµÐ³Ð¾ Ñ‡ÐµÑ€ÐµÐ· xcom_pull
    - Ñ‡ÐµÐ¼ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ ÐºÐ»ÑŽÑ‡ XCom Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ñ‚Ð°ÑÐºÐ¸ Ð¸ Ð·Ð°Ñ‡ÐµÐ¼ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¹ key
    - ÐºÐ°Ðº Ð¿Ð¾ Ð»Ð¾Ð³Ð°Ð¼ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¾Ð´Ð½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð° Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚, Ð° Ð´Ñ€ÑƒÐ³Ð°Ñ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¸Ð· XCom
- ðŸŽ¯ DAG simple_communications_between_tasks_with_target_values:
    - Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ-Ñ‚Ð°ÑÐºÐ° get_common_date ÐºÐ°Ðº ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¾Ð±Ñ‰ÐµÐ¹ Ð´Ð°Ñ‚Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÐ³Ð¾ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°
    - ÐºÐ°Ðº Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‚Ð°ÑÐºÑƒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¿ÑƒÑˆÐ¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² XCom Ð¸ Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð·Ð°Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ð¸Ñ… Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ / Ñ‚Ð°ÑÐºÐ¸
    - Ð¿Ñ€Ð¸Ð¼ÐµÑ€ context.get("task_instance").xcom_pull("get_common_date") Ð¸ Ñ€Ð°Ð·Ð±Ð¾Ñ€, Ñ‡Ñ‚Ð¾ Ð·Ð´ÐµÑÑŒ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ð¾Ð´
      ÐºÐ°Ð¿Ð¾Ñ‚Ð¾Ð¼
- ðŸš« ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ Ð·Ð»Ð¾ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÑÑ‚ÑŒ XCom:
    - ÑÐ»Ð¾Ð¶Ð½Ð¾ Ð´ÐµÐ±Ð°Ð¶Ð¸Ñ‚ÑŒ Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚Ð°ÐºÐ¾Ð¹ ÐºÐ¾Ð´, Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð² Ð¿Ñ€Ð¾Ð´Ðµ
    - ÑÐ¸Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ Airflow Ð¸ Ð¼ÐµÑ‚Ð°ÑÑ‚Ð¾Ñ€Ð°: Ð±ÐµÐ· Ð½Ð¸Ñ… Ð»Ð¾Ð³Ð¸ÐºÐ° Ð½Ðµ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ
    - Ð¼ÐµÑ‚Ð°ÑÑ‚Ð¾Ñ€ Ð·Ð°ÑÐ¾Ñ€ÑÐµÑ‚ÑÑ XCom-Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸, Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¶Ð¸Ð²ÑƒÑ‚ Â«Ð²ÐµÑ‡Ð½Ð¾Â», ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½Ðµ Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ
    - ÐºÐ°Ðº Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ñ€Ð°ÑÑ‚ÑƒÑ‚ Ð¾Ð±ÑŠÑ‘Ð¼Ñ‹ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¿Ñ€Ð¸ Ð´ÐµÑÑÑ‚ÐºÐ°Ñ… / ÑÐ¾Ñ‚Ð½ÑÑ… DAGâ€™Ð¾Ð² Ð¸ Ñ‡Ð°ÑÑ‚Ñ‹Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ…
    - Ð³Ð´Ðµ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñƒ XCom (Ñ„Ð°Ð¹Ð» xcom.py Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ°Ñ… Airflow)
    - ÐºÐ¾Ð³Ð´Ð° ÑÑ‚Ð¾Ð¸Ñ‚ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° Custom XCom Backend Ð¸ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
- âœ… ÐšÐ¾Ð³Ð´Ð° XCom Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð»ÐµÐ·ÐµÐ½:
    - Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² Ð¸ ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ (Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ API, ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð‘Ð”, Ñ„Ð»Ð°Ð³Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº)
    - Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ° ÑÑ‚Ð°Ð¿Ð¾Ð² Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° ÐºÐ°Ðº Â«Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾Â», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð²Ñ‹ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ DAG
    - Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ… ÑÐ»ÑƒÐ¶ÐµÐ±Ð½Ñ‹Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹, Ð° Ð½Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾Ð²Ð½Ñ DWH
- ðŸ’£ ÐÐ½Ñ‚Ð¸Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð¿Ñ€Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ XCom:
    - Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ñ€Ð°Ð·Ð½Ñ‹Ð¼Ð¸ DAGâ€™Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· XCom
    - ÑÐºÐ»Ð°Ð´Ñ‹Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð¾Ð±ÑŠÑ‘Ð¼Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² XCom Ð²Ð¼ÐµÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
    - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ XCom ÐºÐ°Ðº ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð‘Ð” Â«Ð½Ð° Ð²ÑÐµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð¶Ð¸Ð·Ð½Ð¸Â»
    - Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡Ð¸ÑÑ‚ÐºÑƒ XCom Ð¸ Ñ€Ð¾ÑÑ‚ Ð¼ÐµÑ‚Ð°ÑÑ‚Ð¾Ñ€Ð°, Ð¿Ð¾ÐºÐ° Ð¾Ð½ Ð½Ðµ Ð½Ð°Ñ‡Ð½Ñ‘Ñ‚ Ð·Ð°Ð¼ÐµÐ´Ð»ÑÑ‚ÑŒ Airflow

ðŸ—‚ï¸ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ñ ÐºÐ¾Ð´Ð¾Ð¼: https://github.com/k0rsakov/pet_project_how_to_use_xcom_in_airflow

âœ‰ï¸ Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Data Engineering Ð¸ Apache Airflow â€” Ð¿Ð¸ÑˆÐ¸ Ð²
Ð»Ð¸Ñ‡ÐºÑƒ: https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0

ðŸ’¡ Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð²Ð¸Ð´ÐµÐ¾ â€” Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸: ÐºÐ¾Ð³Ð´Ð° XCom â€” Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ð¼ÐµÐ½Ð° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼Ð¸ Ð¸ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ð¼Ð¸
Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸,
Ð° ÐºÐ¾Ð³Ð´Ð° Ð»ÑƒÑ‡ÑˆÐµ ÑÐ¿Ñ€Ð¾ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¶Ð¸Ð»Ð¸ Ð²Ð¾ Ð²Ð½ÐµÑˆÐ½ÐµÐ¼ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ, Ð° Airflow Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð» Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°
Ð¾Ñ€ÐºÐµÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ.

Ð¢Ð°Ð¹Ð¼ÐºÐ¾Ð´Ñ‹:

- 00:00 â€“ ÐÐ°Ñ‡Ð°Ð»Ð¾
- 00:15 â€“ ÐŸÑ€Ð¾ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
- 01:24 â€“ ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ DAG Ð¿Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð² XCom
- 04:11 â€“ Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ TaskInstance / ti
- 06:49 â€“ ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ñ XCom Ð²Ð½ÑƒÑ‚Ñ€Ð¸ DAG
- 11:04 â€“ Ð‘Ð¾ÐµÐ²Ð¾Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ XCom Ð²Ð½ÑƒÑ‚Ñ€Ð¸ DAG Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ API
- 16:48 â€“ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸

#apacheairflow #airflow #xcom #airflowxcom #dag #apacheairflowtutorial #airflowtutorial #airflowforbeginners
#dataengineering #etl #elt #dwh #python #dataengineer #junior #middle #pipeline

## Ðž Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ

### Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ

ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:

```bash
python3.12 -m venv venv && \
source venv/bin/activate && \
pip install --upgrade pip && \
pip install poetry && \
poetry lock && \
poetry install
```

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Airflow Ñ‡ÐµÑ€ÐµÐ· Docker

ÐœÑ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Airflow, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸ [Dockerfile](Dockerfile)
Ð¸ [docker-compose.yaml](docker-compose.yaml).

Ð”Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° Ñ Airflow, Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:

```bash
docker-compose up -d
```

Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Airflow Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ http://localhost:8080/, ÐµÑÐ»Ð¸ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚, Ñ‚Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸
Ð¿Ð¾ Ñ…Ð¾ÑÑ‚Ñƒ http://0.0.0.0:8080/.

#### Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð² Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ

Ð”Ð»Ñ Ñ‚Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ°ÐºÐ¾Ð¹-Ñ‚Ð¾ Ð¿Ð°ÐºÐµÑ‚ Ð² Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ, Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:

* Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð² [Dockerfile](Dockerfile)
* Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:

```bash
docker-compose build
```

* Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ:

```bash
docker-compose up -d
```

### DeBug ÐºÐ»Ð°ÑÑÐ° TaskInstance

Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð½Ð¾Ð²Ñ‹Ð¹ DAG Ð¸Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ â€“ [simple_push_xcom_values.py](dags/simple_push_xcom_values.py):

ÐŸÐ¾ÑÑ‚Ð°Ð²ÑŒ Ñ‚Ð¾Ñ‡ÐºÑƒ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‹ Ð² ÐºÐ¾Ð½Ñ†Ðµ ÐºÐ¾Ð´Ð° Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸ Ð¾Ñ‚Ð»Ð°Ð´ÐºÑƒ.

Ð—Ð°Ñ‚ÐµÐ¼ Ñ‚Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑˆÑŒ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ TaskInstance Ð¸ ÐµÐ³Ð¾ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹.

```python
import pendulum

from airflow import DAG
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ DAG
OWNER = "i.korsakov"
DAG_ID = "simple_push_xcom_values"

LONG_DESCRIPTION = """
# LONG DESCRIPTION

"""

SHORT_DESCRIPTION = "SHORT DESCRIPTION"

# ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð´Ð»Ñ default_args
# https://github.com/apache/airflow/blob/343d38af380afad2b202838317a47a7b1687f14f/airflow/example_dags/tutorial.py#L39
args = {
    "owner": OWNER,
    "start_date": pendulum.datetime(year=2025, month=1, day=1, tz="UTC"),
    "retries": 3,
    "retry_delay": pendulum.duration(hours=1),
}


def simple_push_xcom(**context) -> pendulum.DateTime:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð´Ð°Ñ‚Ñƒ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° DAG.

    @param context: ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ DAG.
    @return: data_interval_start:pendulum.DateTime.
    """

    return context.get("data_interval_start")


with DAG(
        dag_id=DAG_ID,
        schedule="0 10 * * *",
        default_args=args,
        tags=["xcom"],
        description=SHORT_DESCRIPTION,
        max_active_tasks=1,
        max_active_runs=1,
) as dag:
    dag.doc_md = LONG_DESCRIPTION

    start = EmptyOperator(
        task_id="start",
    )

    simple_push_xcom = PythonOperator(
        task_id="simple_push_xcom",
        python_callable=simple_push_xcom,
    )

    end = EmptyOperator(
        task_id="end",
    )

    start >> simple_push_xcom >> end

if __name__ == "__main__":
    import uuid
    from airflow.utils.state import State
    from airflow.utils.types import DagRunType
    from airflow.models import DagRun
    from airflow.utils.session import create_session

    task = dag.get_task("simple_push_xcom")

    with create_session() as session:
        dag_run = DagRun(
            dag_id=dag.dag_id,
            run_id=f"manual_debug_{str(uuid.uuid4())}",
            execution_date=pendulum.now("UTC"),
            start_date=pendulum.now("UTC"),
            run_type=DagRunType.MANUAL,
            state=State.RUNNING,
        )
        session.add(dag_run)
        session.commit()

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ TaskInstance
        from airflow.models import TaskInstance

        ti = TaskInstance(task=task, run_id=dag_run.run_id)
        ti.state = State.RUNNING

        print(f"TaskInstance created: {ti}")
        print(f"ti.task_id: {ti.task_id}")
        print(f"ti.dag_id: {ti.dag_id}")
        print(f"ti.state: {ti.state}")
```